# twig-frontend
Модуль верстки страниц с использованием шаблонизатора Twig

## Установка
```
npm i -D @alldigitalads/nodejs_modules-twig-frontend
```
### Установка домена для генерации абсолютных ссылок

По умолчанию для генерации абсолютных путей используется адрес http://localhost:8080<br/>
Изменить домен можно:
1. Через TwigConfigurator
    ```javascript
    TwigConfigurator.setDomain('http://new.domain[:port]');
    ```
2. Через консольную команду
    ```bash
    CUSTOM_DOMAIN=http://new.domain[:port] npm run <команда из package.json>
    ```
    Рекомендуется в команде запуска сервера из package.json воспользоваться ключем --allowed-hosts (см. 
    [документацию](https://webpack.js.org/configuration/dev-server/#devserver-allowedhosts))
    
Пример установки домена на локальной машине без проксирующих web-серверов
```
# package.json
{
  "scripts" : {
    "server:custom": "webpack-dev-server --inline --hot --mode=development --allowed-hosts .com,.dev,.local"
  }
}

# command line
CUSTOM_DOMAIN=http://npm-test.com:8080 npm run server:custom

# файл hosts
127.0.0.1  npm-test.com
127.0.0.1  npm-test.dev
```
Запущенный сервер будет доступен как по адресу http://npm-test.local:8080, так и по адресу http://npm-test.com:8080. 
Однако, в обоих случаях в генерируемых ссылках в качестве домена будет стоять http://npm-test.com:8080. 

## Настройка proxy
Структура: 
```javascript
{
  bypass: {
    '<prefix>': {
      method: string|array,
      path: string,
      script: string|function
    }
  },
  proxy: {
      '<URI>': {
        target: string,
        secure: false,
        method: string|array,
        pathRewrite: function
      }
  }
}
```
- _method_ - допустимый тип запроса (GET, POST, PUT и т.д.). Может быть как строкой, если задан один тип запроса, так и 
массивом, если допускаются несколько типов запросов


### Bypass
Секция отвечает за динамическое формирование данных в ответе.
- _\<prefix\>_ - часть URL после домена, общая для группы адресов
- _path_ - полный путь к директории в которой лежат json-файлы, доступные через web. При запросе _/prefix/a/b/c_ и 
настройке _path: '\_\_dirname+"/subdir1/subdir2"'_ будет возвращен файл _/path_to_project/subdir1/subdir2/a\_b\_c.json_
- _script_ - скрипт, который будет выполнен в случае, если параметры запроса совпадают с _method_ и _prefix_. Значением 
может быть либо функция, либо строка, содержащая полный путь к JS-файлу

В одной секции может быть задан только один из параметров - _path_ или _script_. Преимуществом пользуется первый.

### Proxy
Секция отвечает за "скрытое" перенаправление запросов
- _\<URI\>_ - URI который будет перехвачен proxy
- _secure_ - всегда false
- _target_ - URL (или часть его) на который будет перенаправлен запрос. Если _target_ отсутствует или 
начинается не с http(s), то в качестве домена будет использован либо дефолтный домен, либо заданный через переменную 
окружения CUSTOM_DOMAIN
- _pathRewrite_ - функция, которая возвращает правую часть URL. Может отсутствовать - в этом случае все запросы, которые 
соответствуют _\<URI\>_ будут перенаправлены на _target_

Общая схема работы правил следующая:
http(s)://domain/part1/part2/other1 -&gt; target+pathRewrite, при этом _&lt;URI&gt;_ должно быть строкой '/part1' 
или '/part1/part2', или '/part1/part2/other1'

## Использование
```javascript
const TwigCompilator = new (require('@alldigitalads/nodejs_modules-twig-frontend'));

TwigCompilator
    .setRenderList({$список_шаблонов_для_рендеринга})
    .setTranslateMessages({$объект_с_константами_локализации})
    .setRouteRules({$объект_с_правилами_маршрутизации})
;

module.exports = TwigCompilator.getWebpackConfig();
```

### Доступные методы

- **setDomain(string)** - Задает домен, для подстановки в абсолютные URL. Должен совпадать с доменом на котором запущен dev-сервер.
По умолчанию: http://localhost:8080
- **setOutput({path: string, publicPath: string, filename: string})** - Задает папку вывода скомпилированных файлов, URI к этой
папке (относительно домена) и шаблон формирования имен js-файлов
- **setPath(name, path)** - Задает пути (относительно папки проекта) к исходникам. Аргумент "name" может быть как строкой, так и объектом.
Варианты вызова: 1. setPath('templatePath', './src/twig/templates'); 2. setPath({templatePath: './src/twig/templates'}). Аргумент
"name" может принимать следующие значения: sourcePath (по умолчанию './src'), cssPath (по умолчанию './crs/css'), imagesPath 
(по умолчанию './src/images'), fontsPath ('./src/fonts'), jsPath ('./src/js'), videoPath ('./src/video'), templatePath ('./src/twig/templates'),
testDataPath ('./src/twig/dataTest').
- **setRenderList(object)** - Задает список шаблонов для компиляции в формате {'путь/к_шаблону': 'Название страницы'}. Путь к шаблону
указывается относительно _templatePath_
- **setTranslateMessages(object)** - Задает объект с константами локализации
- **setRouteRules(object)** - Задает правила построения URL'ов
- **setFixtures(string|object)** - Устанавливает фикстуры, которые будут переданы в загрузчик шаблона
- **setRecompileDelay(integer)** - Устанавливает период перекомпиляции файлов
- **setDynamicFixtures(string|object)** - Добавляет правила копирования файлов при компиляции (откуда-куда).
- **addPlugin(array|object)** - Добавляет плагин(ы)
- **getWebpackConfig()** - Возвращает объект настроек для webpack

## Список доступных функций и фильтров Twig
### Функции
- absolute_url(path) [v1.0.0] - Возвращает абсолютный URL для заданного относительного URL
- asset(path) [v1.0.0] - Возвращает публичный путь к _path_
- attribute(object, method, params) - [https://twig.symfony.com/doc/2.x/functions/attribute.html](https://twig.symfony.com/doc/2.x/functions/attribute.html)
- block(block) - [https://twig.symfony.com/doc/2.x/functions/block.html](https://twig.symfony.com/doc/2.x/functions/block.html)
- cycle(arr, i) - [https://twig.symfony.com/doc/2.x/functions/cycle.html](https://twig.symfony.com/doc/2.x/functions/cycle.html)
- date(date, time) - [https://twig.symfony.com/doc/2.x/functions/dump.html](https://twig.symfony.com/doc/2.x/functions/dump.html)
- dump() - [https://twig.symfony.com/doc/2.x/functions/dump.html](https://twig.symfony.com/doc/2.x/functions/dump.html)
- form(form, options) [v.1.0.0] - Строит HTML-форму
- form_end(form) [v1.0.0] - Рендерит закрывающий тег формы, а также кнопки submit и reset
- form_errors(element) [v1.0.0] - Рендерит ошибки валидации формы или ее элемента
- form_label(element, label) [v1.0.0] - Рендерит тег <label> для заданного элемента. Если _label_ не задан, то текст будет
сгенерирован на основании имени поля формы
- form_rest(form) [v1.0.0] - Рендерит все поля формы, которые не были отрендерены ранее
- form_row(field, options) [v1.0.0] - Рендерит поле формы (label, errors, widget)
- form_start(form, options) [v1.0.0] - Рендерит открывающий тег HTML-формы
- form_widget(field, options) [v1.0.0] - Рендерит HTM-код элемента формы
- max(values) - [https://twig.symfony.com/doc/2.x/functions/max.html](https://twig.symfony.com/doc/2.x/functions/max.html)
- min(values) - [https://twig.symfony.com/doc/2.x/functions/min.html](https://twig.symfony.com/doc/2.x/functions/min.html)
- path(name, params) [v1.0.0] - Возвращает относительный URL (без схемы и хоста) для заданного роута
- parent() - [https://twig.symfony.com/doc/2.x/functions/parent.html](https://twig.symfony.com/doc/2.x/functions/parent.html)
- random(values) - [https://twig.symfony.com/doc/2.x/functions/random.html](https://twig.symfony.com/doc/2.x/functions/random.html)
- range(min, max, step) - [https://twig.symfony.com/doc/2.x/functions/range.html](https://twig.symfony.com/doc/2.x/functions/range.html)
- source(name, ignore_missing) - [https://twig.symfony.com/doc/2.x/functions/source.html](https://twig.symfony.com/doc/2.x/functions/source.html)
- template_from_string(template) - [https://twig.symfony.com/doc/2.x/functions/template_from_string.html](https://twig.symfony.com/doc/2.x/functions/template_from_string.html)
- url(name, params) [v1.0.0] - Возвращает абсолютный URL для заданного роута


### Фильтры
- abs(value) - [https://twig.symfony.com/doc/2.x/filters/abs.html](https://twig.symfony.com/doc/2.x/filters/abs.html)
- batch(items, params) - [https://twig.symfony.com/doc/2.x/filters/batch.html](https://twig.symfony.com/doc/2.x/filters/batch.html)
- capitalize(value) - [https://twig.symfony.com/doc/2.x/filters/capitalize.html](https://twig.symfony.com/doc/2.x/filters/capitalize.html)
- date(value, params) - [https://twig.symfony.com/doc/2.x/filters/date.html](https://twig.symfony.com/doc/2.x/filters/date.html)
- date_modify(value, params) - [https://twig.symfony.com/doc/2.x/filters/date_modify.html](https://twig.symfony.com/doc/2.x/filters/date_modify.html)
- default(value, params) - [https://twig.symfony.com/doc/2.x/filters/default.html](https://twig.symfony.com/doc/2.x/filters/default.html)
- escape(value, params), e(value, params) - [https://twig.symfony.com/doc/2.x/filters/escape.html](https://twig.symfony.com/doc/2.x/filters/escape.html)
- first(value) - [https://twig.symfony.com/doc/2.x/filters/first.html](https://twig.symfony.com/doc/2.x/filters/first.html)
- format(value, params) - [https://twig.symfony.com/doc/2.x/filters/format.html](https://twig.symfony.com/doc/2.x/filters/format.html)
- join(value, params) - [https://twig.symfony.com/doc/2.x/filters/join.html](https://twig.symfony.com/doc/2.x/filters/join.html)
- json_encode(value) - [https://twig.symfony.com/doc/2.x/filters/json_encode.html](https://twig.symfony.com/doc/2.x/filters/json_encode.html)
- keys(value) - [https://twig.symfony.com/doc/2.x/filters/keys.html](https://twig.symfony.com/doc/2.x/filters/keys.html)
- last(value) - [https://twig.symfony.com/doc/2.x/filters/last.html](https://twig.symfony.com/doc/2.x/filters/last.html)
- length(value) - [https://twig.symfony.com/doc/2.x/filters/length.html](https://twig.symfony.com/doc/2.x/filters/length.html)
- lower(value) - [https://twig.symfony.com/doc/2.x/filters/lower.html](https://twig.symfony.com/doc/2.x/filters/lower.html)
- merge(value, params) - [https://twig.symfony.com/doc/2.x/filters/merge.html](https://twig.symfony.com/doc/2.x/filters/merge.html)
- nl2br(value) - [https://twig.symfony.com/doc/2.x/filters/nl2br.html](https://twig.symfony.com/doc/2.x/filters/nl2br.html)
- number_format(value, params) - [https://twig.symfony.com/doc/2.x/filters/number_format.html](https://twig.symfony.com/doc/2.x/filters/number_format.html)
- raw(value) - [https://twig.symfony.com/doc/2.x/filters/raw.html](https://twig.symfony.com/doc/2.x/filters/raw.html)
- replace(value, params) - [https://twig.symfony.com/doc/2.x/filters/replace.html](https://twig.symfony.com/doc/2.x/filters/replace.html)
- reverse(value) - [https://twig.symfony.com/doc/2.x/filters/reverse.html](https://twig.symfony.com/doc/2.x/filters/reverse.html)
- round(value, params) - [https://twig.symfony.com/doc/2.x/filters/round.html](https://twig.symfony.com/doc/2.x/filters/round.html)
- slice(value, params) - [https://twig.symfony.com/doc/2.x/filters/slice.html](https://twig.symfony.com/doc/2.x/filters/slice.html)
- split(value, params) - [https://twig.symfony.com/doc/2.x/filters/split.html](https://twig.symfony.com/doc/2.x/filters/split.html)
- sort(value) - [https://twig.symfony.com/doc/2.x/filters/sort.html](https://twig.symfony.com/doc/2.x/filters/sort.html)
- striptags(value, allowed) - [https://twig.symfony.com/doc/2.x/filters/striptags.html](https://twig.symfony.com/doc/2.x/filters/striptags.html)
- title(value) - [https://twig.symfony.com/doc/2.x/filters/title.html](https://twig.symfony.com/doc/2.x/filters/title.html)
- trans(code, params) [v1.0.0] - Вызов функции локализации
- trim(value, params) - [https://twig.symfony.com/doc/2.x/filters/trim.html](https://twig.symfony.com/doc/2.x/filters/trim.html)
- truncate(value, length, preserve, separator) - Обрезает строку до указанной длины и добавляет в конец строки _separator_.
Если задан _preserve = true_, то строка будет обрезана до ближайшего после _length_ позиции пробела.
- upper(value) - [https://twig.symfony.com/doc/2.x/filters/upper.html](https://twig.symfony.com/doc/2.x/filters/upper.html)
- url_encode(value) - [https://twig.symfony.com/doc/2.x/filters/url_encode.html](https://twig.symfony.com/doc/2.x/filters/url_encode.html)
